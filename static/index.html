<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <title>Fuzzy Matching</title>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark static-top">
    <!--<a class="navbar-brand" href="#">
        <img src="" alt="logo">
    </a>-->
    <a class="navbar-brand" href="#">
        fuzzymatch.in
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
            aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a id="main" class="nav-link" href="##">Home
                    <span class="sr-only">(current)</span>
                </a>
            </li>
            <li class="nav-item">
                <a id="api_docs" class="nav-link" href="#">
                    API Docs
                </a>
            </li>
            <li class="nav-item">
                <a id="contact" class="nav-link" href="https://datahappy.wordpress.com/contact/" target="_blank">
                    Contact
                </a>
            </li>
        </ul>
    </div>
</nav>

<div class="container-fluid bg-light text-dark">

    <div class="container pt-5 bg-white text-dark">
        <div class="row">
            <div class="col-sm">
                <label for="mode">Choose mode:</label>
                <select class="form-select" name="mode" id="mode">
                    <option value="simple">simple</option>
                    <option value="deepDive">deepDive</option>
                    <option value="combined">combined</option>
                </select>
            </div>
            <div class="col-sm">
                <button class="btn btn-primary" onclick="buttonHandler()" id="submitButton">Get fuzzy!</button>

            </div>
            <div class="col-sm">

            </div>
        </div>

        <div class="row">
            <div class="col-sm">
                <label for="formControlRange">Return results above </label>
                <input type="range" class="form-control-range" id="formControlRange">
            </div>
        </div>

    </div>

    <div class="container pt-5 bg-white text-dark">
        <div class="row">
            <div class="col-sm">
                <label for="stringsToMatch">Strings to match:</label>
                <textarea class="form-control" id="stringsToMatch" name="stringsToMatch" rows="20" cols="50"></textarea>

            </div>
            <div class="col-sm">
                <label for="stringsToMatchIn">Strings to match in:</label>
                <textarea class="form-control" id="stringsToMatchIn" name="stringsToMatchIn" rows="20"
                          cols="50"></textarea>

            </div>
            <div class="col-sm">
                <label for="resultsTable">Results:</label>
                <table class="table table-bordered" id="resultsTable">
                    <thead>
                    <tr>
                        <th scope="col">Input</th>
                        <th scope="col">Best Match</th>
                        <th scope="col">Result</th>
                    </tr>
                    </thead>
                    <tbody id="resultsTableBody">

                    </tbody>
                </table>
            </div>

        </div>
    </div>

</div>

<script>
    const BaseUrl = 'http://localhost:8080/api/v1/requests/';

    function createRequest() {
        let inputStringsToMatch = document.getElementById("stringsToMatch").value;
        let inputStringsToMatchIn = document.getElementById("stringsToMatchIn").value;
        let inputMode = document.getElementById("mode").value;

        console.log(inputStringsToMatch, inputStringsToMatchIn, inputMode)

        const Data = JSON.stringify({
            // stringsToMatch: "apple, bee, cee",
            // stringsToMatchIn: "tree, fee, freeze, squeeze",
            // mode: "combined"
            stringsToMatch: inputStringsToMatch,
            stringsToMatchIn: inputStringsToMatchIn,
            mode: inputMode
        });
        const otherParam = {
            headers: {
                "content-type": "application/json; charset=UTF-8"
            },
            body: Data,
            method: "POST"
        };

        fetch(BaseUrl, otherParam)
            .then(data => {
                return data.json()
            })
            .then(res => {
                fetchResults(res["RequestID"])
            })
            .catch(error => console.log(error))
    }

    function fetchResults(requestId) {
        const otherParam2 = {
            headers: {
                "content-type": "application/json; charset=UTF-8"
            },
            method: "GET"
        };

        fetch(BaseUrl + requestId + '/', otherParam2)
            .then(data => {
                return data.json()
            })
            .then(res => {
                console.log(res)
                if (res["ReturnedAllRows"] === true) {
                    updateResultsTable(res["Results"])
                } else {
                    updateResultsTable(res["Results"]);
                    fetchResults(requestId);
                }
            })
            .catch(error => console.log(error))

    }

    function clearResultsTable() {
        let container = document.getElementById('resultsTableBody');
        container.innerHTML = '';
    }

    function updateResultsTable(results) {
        let htmlResultsTable = '';
        let container = document.getElementById('resultsTableBody');

        for (let i = 0; i < results.length; i++) {
            let htmlTableRow = `<tr>
                                <td>${results[i]["StringToMatch"]}</td>
                                <td>${results[i]["StringMatched"]}</td>
                                <td>${results[i]["Result"]}</td>
                            </tr>`;

            htmlResultsTable += htmlTableRow;
        }

        container.innerHTML += htmlResultsTable;
    }

    function buttonHandler() {
        clearResultsTable();
        createRequest();
    }

</script>

<script>
    const url = window.location.href;

    const els = document.querySelectorAll(".dropdown-menu a");
    for (let i = 0, l = els.length; i < l; i++) {
        let el = els[i];
        if (el.href === url) {
            el.classList.add("active");
            let parent = el.closest(".main-nav"); // add this class for the top level "li" to get easy the parent
            parent.classList.add("active");
        }
    }
</script>
</body>

</html>